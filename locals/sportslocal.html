<!DOCTYPE html>
<html>

<head>
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/favicons/manifest.json">
  <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/favicons/favicon.ico">
  <meta name="msapplication-config" content="/favicons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
  <title>New Sports Announcement</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/locals.css">
  <script src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
  <script>
    var config = {
      apiKey: "AIzaSyBgT_WotHdQwc4YX8IcC2tYPJ2BxPifS2Y",
      authDomain: "hertfordjcr-bf40e.firebaseapp.com",
      databaseURL: "https://hertfordjcr-bf40e.firebaseio.com",
      storageBucket: "hertfordjcr-bf40e.appspot.com",
      messagingSenderId: "318620778170"
    };
    firebase.initializeApp(config);

    function processForm(e) {
      var pass = document.getElementById("pass").value;
      if (e.preventDefault) e.preventDefault();
      firebase.auth().signInWithEmailAndPassword("sportspass@michaelagius.uk", pass).catch(function (error) {
        var errorCode = error.code;
        var errorMessage = error.message;
        alert(errorMessage);
      }).then(removeOld);
      // must return false to prevent the default form behavior
      return false;
    }

    function removeOld() {
      firebase.database().ref("/sports").once('value').then(function (snapshot) {
        var now = new Date().getTime();
        snapshot.forEach(function (item) {
          if (now - item.val().date > 1209600000){
            item.ref.remove();
          }
        });
        addNew();
      });
    }

    function addNew() {
      var newPostKey = firebase.database().ref().child('sports').push().key;
      var updates = {};
      var sport = document.getElementById("sport").value;
      var content = document.getElementById("contentmsg").value;
      updates['sports/' + newPostKey + "/sport"] = sport;
      updates['sports/' + newPostKey + "/date"] = new Date().getTime();
      updates['sports/' + newPostKey + "/message"] = content;
      firebase.database().ref().update(updates).then(signOut);
    }

    function signOut() {
      firebase.auth().signOut().then(function () {
        alert("Announcement uploaded :D");
      }, function (error) {
        alert(error.message);
      });
    }

    function ready() {
      var form = document.getElementById('sform');
      if (form.attachEvent) form.attachEvent("submit", processForm);
      else form.addEventListener("submit", processForm);
    }
  </script>
</head>

<body onload="ready()">
  <header>
    <h1>New Sports Announcement</h1></header>
  <div class="spacer"></div>
  <main class="card">
    <form id="sform" class="sform" method="POST" autocomplete="off">
      <input id="pass" autocomplete="off" type="text" name="name" placeholder="password" required>
      <input id="sport" type="text" name="name" placeholder="sport" required>
      <textarea id="contentmsg" name="message" placeholder="announcement" rows="10"></textarea>
      <button class="mbutton" type="submit">send</button>
    </form>
  </main>
  <div class="spacer"></div>
  <footer>&copy; Michael Agius</footer>
</body>

</html>